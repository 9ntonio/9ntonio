[build]
command = "yarn clean && yarn build:production"
publish = "public"

[build.environment]
NODE_VERSION = "18.17.0"
GATSBY_CPU_COUNT = "2"
GATSBY_CONTINUE_BUILD_ON_MISSING_ADAPTER = "true"

# Enable text compression while keeping asset processing disabled
[build.processing]
skip_processing = false

[build.processing.css]
bundle = false
minify = true

[build.processing.js]
bundle = false
minify = true

[build.processing.html]
pretty_urls = true

[build.processing.images]
compress = false

[[plugins]]
package = "@netlify/plugin-gatsby"

# Optimized caching headers for static assets (JS and CSS headers moved to compression section)

[[headers]]
for = "/*.woff2"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/*.webp"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/*.avif"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/*.jpg"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/*.png"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/*.svg"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

# HTML files - short cache for content updates (moved to compression section)

# Optimized caching headers for text assets (compression handled automatically by Netlify)
[[headers]]
for = "/*.js"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/*.css"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/*.html"
[headers.values]
Cache-Control = "public, max-age=0, must-revalidate"

[[headers]]
for = "/*.json"
[headers.values]
Cache-Control = "public, max-age=3600"

[[headers]]
for = "/*.xml"
[headers.values]
Cache-Control = "public, max-age=3600"

# Security headers - SAMEORIGIN allows embedding videos on our site
[[headers]]
for = "/*"
[headers.values]
X-Frame-Options = "SAMEORIGIN"
X-XSS-Protection = "1; mode=block"
X-Content-Type-Options = "nosniff"
Referrer-Policy = "same-origin"
Cache-Control = "public, max-age=0, must-revalidate"

# Important: Ensure proper routing for unknown-pleasures section and its assets
[[redirects]]
from = "/unknown-pleasures"
to = "/unknown-pleasures/index.html"
status = 200
force = true

[[redirects]]
from = "/unknown-pleasures/*"
to = "/unknown-pleasures/:splat"
status = 200
force = true

# Important: Handle assets properly - ensure they can be accessed from both locations
[[redirects]]
from = "/assets/*"
to = "/assets/:splat"
status = 200
force = true

# Ensure robots.txt is served correctly (before SPA fallback)
[[redirects]]
from = "/robots.txt"
to = "/robots.txt"
status = 200
force = false

# Ensure sitemap is served correctly
[[redirects]]
from = "/sitemap*"
to = "/sitemap:splat"
status = 200
force = false

# Fallback for SPA (must be last)
[[redirects]]
from = "/*"
to = "/index.html"
status = 200
