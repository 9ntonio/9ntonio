[build]
command = "yarn clean && yarn build:production"
publish = "public"

[build.environment]
NODE_VERSION = "18.17.0"
GATSBY_CPU_COUNT = "2"
GATSBY_CONTINUE_BUILD_ON_MISSING_ADAPTER = "true"

# Disable processing to prevent conflicts with Gatsby's own optimization
[build.processing]
skip_processing = true

[[plugins]]
package = "@netlify/plugin-gatsby"

# Basic security headers only
[[headers]]
for = "/*"
[headers.values]
X-Frame-Options = "DENY"
X-XSS-Protection = "1; mode=block"
X-Content-Type-Options = "nosniff"

# Important: Ensure proper routing for unknown-pleasures section and its assets
[[redirects]]
from = "/unknown-pleasures"
to = "/unknown-pleasures/index.html"
status = 200
force = true

[[redirects]]
from = "/unknown-pleasures/*"
to = "/unknown-pleasures/:splat"
status = 200
force = true

# Important: Handle assets properly - ensure they can be accessed from both locations
[[redirects]]
from = "/assets/*"
to = "/assets/:splat"
status = 200
force = true

# Ensure robots.txt is served correctly (before SPA fallback)
[[redirects]]
from = "/robots.txt"
to = "/robots.txt"
status = 200
force = false

# Ensure sitemap is served correctly
[[redirects]]
from = "/sitemap*"
to = "/sitemap:splat"
status = 200
force = false

# Fallback for SPA (must be last)
[[redirects]]
from = "/*"
to = "/index.html"
status = 200
